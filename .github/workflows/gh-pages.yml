name: Deploy to GitHub Pages (gh-pages)

on:
  push:
    branches:
      - master
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Build and publish to gh-pages
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # allow the workflow to push back to the repo using the provided token
          persist-credentials: true
          # fetch full history so tags/branches can be pushed reliably
          fetch-depth: 0

      - name: Publish to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          # publish_branch: gh-pages (default)
          user_name: silvanoneto
          user_email: dev@silvanoneto.com

      - name: Ensure GitHub Pages source is set to gh-pages (API)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          api="https://api.github.com/repos/${{ github.repository }}/pages"
          echo "PUT $api -> set source to gh-pages"
          curl -sS -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            "$api" | jq -r '.url, .status, .cname' || true

      - name: Show Pages status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          api="https://api.github.com/repos/${{ github.repository }}/pages"
          echo "GET $api -> pages info"
          curl -sS -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$api" | jq || true
